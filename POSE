import cv2
import cv2.aruco as aruco
import numpy as np

aruco_dict = aruco.getPredefinedDictionary(aruco.DICT_6X6_250)
parameters = aruco.DetectorParameters()
detector = aruco.ArucoDetector(aruco_dict, parameters)
cap = cv2.VideoCapture(0)

def get_dummy_camera_matrix(frame_shape):
    size = frame_shape
    focal_length = size[1]
    center = (size[1]/2, size[0]/2)
    cam_matrix = np.array([
        [focal_length, 0, center[0]],
        [0, focal_length, center[1]],
        [0, 0, 1]
    ], dtype=np.float32)
    return cam_matrix

def estimatePose_aruco_marker():
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    corners, ids, _ = detector.detectMarkers(gray)

    if ids is not None:
        aruco.drawDetectedMarkers(frame, corners, ids)
        
        dummy_matrix = get_dummy_camera_matrix(frame.shape)
        dist_coeffs = np.zeros((5, 1))

        for i in range(len(ids)):
            marker_size = 0.05      # 단위: m
            obj_points = np.array([
                [-marker_size/2,  marker_size/2, 0],
                [ marker_size/2,  marker_size/2, 0],
                [ marker_size/2, -marker_size/2, 0],
                [-marker_size/2, -marker_size/2, 0]
            ], dtype=np.float32)

            _, rvec, tvec = cv2.solvePnP(obj_points, corners[i], dummy_matrix, dist_coeffs)
            cv2.drawFrameAxes(frame, dummy_matrix, dist_coeffs, rvec, tvec, 0.03)


while True:
    ret, frame = cap.read()
    
    estimatePose_aruco_marker()

    cv2.imshow('ArUco Axis Test', frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
